<!DOCTYPE html>
<html>
<head>
    <title>Expense Tracker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="login">
        <h2>Expense Tracker</h2>
        <div class="form-row">
            <input type="password" id="password" placeholder="Enter password">
            <button onclick="checkPassword()">Login</button>
        </div>
        <div id="loginError" style="color: red;"></div>
    </div>

    <div id="app" style="display: none;">
    <h2>Expense Tracker</h2>
    <div id="status" class="loading">Connecting to Convex...</div>

    <div class="form-row">
        <input type="number" id="amount" placeholder="Amount">
        <span class="divider">|</span>
        <select id="person">
            <option value="Av">Av</option>
            <option value="Ay">Ay</option>
            <option value="L">L</option>
            <option value="N">N</option>
            <option value="Z">Z</option>
        </select>
        <span class="divider">|</span>
        <input type="text" id="note" placeholder="Note (e.g., dinner, groceries...)">
        <span class="divider">|</span>
        <span class="group-select">
            For: <label><input type="checkbox" class="groupCheck" value="Av" checked> Av</label>
            <label><input type="checkbox" class="groupCheck" value="Ay" checked> Ay</label>
            <label><input type="checkbox" class="groupCheck" value="L" checked> L</label>
            <label><input type="checkbox" class="groupCheck" value="N" checked> N</label>
            <label><input type="checkbox" class="groupCheck" value="Z" checked> Z</label>
        </span>
        <span class="divider">|</span>
        <label>Invoice: <input type="file" id="invoice" accept="image/*,.pdf"></label><span id="invoiceStatus"></span>
        <span class="divider">|</span>
        <button onclick="addExpense()">Add</button>
    </div>

    <h3>Expenses:</h3>
    <ul id="expenseList"></ul>

    <h3>Balances:</h3>
    <div class="balance-links">
        <a href="#" onclick="showCard('Av'); return false;">Av</a>
        <a href="#" onclick="showCard('Ay'); return false;">Ay</a>
        <a href="#" onclick="showCard('L'); return false;">L</a>
        <a href="#" onclick="showCard('N'); return false;">N</a>
        <a href="#" onclick="showCard('Z'); return false;">Z</a>
    </div>

    <div id="card" class="card">
        <h4 id="cardTitle"></h4>
        <div id="cardContent"></div>
    </div>

    <hr>
    <h3>Contact Information</h3>
    <div class="form-row">
        <select id="contactPerson">
            <option value="Av">Av</option>
            <option value="Ay">Ay</option>
            <option value="L">L</option>
            <option value="N">N</option>
            <option value="Z">Z</option>
        </select>
        <input type="text" id="platform" placeholder="Platform (Venmo, PayPal...)">
        <input type="text" id="username" placeholder="Username/Email">
        <button onclick="saveContact()">Save Contact</button>
    </div>
    <div id="contactList"></div>

    <hr>
    <h3>Audit Log</h3>
    <div id="auditLog" class="audit-log"></div>

    <br>
    <button onclick="exportExcel()">Export to Excel</button>

    <div class="github"><a href="https://github.com/zimengxiong/58593b-expense-tracker" target="_blank">source â†—</a></div>
    </div>

    <script>
        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function checkPassword() {
            const input = document.getElementById('password').value;
            const hash = await sha256(input);
            if (hash === "048cca692ad6a1edd18633b42e86df863266644d294ec992af1cd39f2153a63a") {
                sessionStorage.setItem('auth', 'true');
                showApp();
            } else {
                document.getElementById('loginError').textContent = 'Incorrect password';
            }
        }

        function showApp() {
            document.getElementById('login').style.display = 'none';
            document.getElementById('app').style.display = 'block';
        }

        if (sessionStorage.getItem('auth') === 'true') {
            showApp();
        }

        document.getElementById('password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') checkPassword();
        });

        window.checkPassword = checkPassword;
    </script>

    <script type="module">
        import { ConvexClient } from "https://esm.run/convex/browser";

        const CONVEX_URL = "https://content-grouse-739.convex.cloud";
        const client = new ConvexClient(CONVEX_URL);
        const people = ['Av', 'Ay', 'L', 'N', 'Z'];

        let expenses = [];
        let contacts = {};
        let auditLog = [];
        let invoiceUrls = {};
        let pendingInvoiceId = null;

        window.addExpense = addExpense;
        window.editExpense = editExpense;
        window.removeExpense = removeExpense;
        window.saveContact = saveContact;
        window.showCard = showCard;
        window.exportExcel = exportExcel;

        let connected = false;
        function setConnected() {
            if (!connected) {
                connected = true;
                const status = document.getElementById('status');
                status.textContent = 'Connected to Convex';
                status.classList.remove('loading');
                status.classList.add('connected');
            }
        }

        client.onUpdate("expenses:list", {}, async (data) => {
            expenses = data || [];
            for (const e of expenses) {
                if (e.invoiceId && !invoiceUrls[e.invoiceId]) {
                    const url = await client.query("files:getUrl", { storageId: e.invoiceId });
                    if (url) invoiceUrls[e.invoiceId] = url;
                }
            }
            renderExpenses();
            setConnected();
        });

        client.onUpdate("contacts:list", {}, (data) => {
            contacts = {};
            (data || []).forEach(c => {
                if (!contacts[c.person]) contacts[c.person] = [];
                contacts[c.person].push({ platform: c.platform, username: c.username });
            });
            renderContacts();
        });

        client.onUpdate("auditLog:list", {}, (data) => {
            auditLog = data || [];
            renderAuditLog();
        });

        async function compressImage(file, maxWidth = 1200, quality = 0.7) {
            return new Promise((resolve) => {
                if (file.type === 'application/pdf') {
                    resolve(file);
                    return;
                }
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        canvas.toBlob((blob) => resolve(blob), 'image/jpeg', quality);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        async function uploadFile(file) {
            const compressed = await compressImage(file);
            const uploadUrl = await client.mutation("files:generateUploadUrl", {});
            const response = await fetch(uploadUrl, {
                method: "POST",
                headers: { "Content-Type": compressed.type || file.type },
                body: compressed,
            });
            const { storageId } = await response.json();
            return storageId;
        }

        async function addExpense() {
            const amount = parseFloat(document.getElementById('amount').value);
            const person = document.getElementById('person').value;
            const note = document.getElementById('note').value.trim();
            const checkboxes = document.querySelectorAll('.groupCheck:checked');
            const group = Array.from(checkboxes).map(cb => cb.value);
            const fileInput = document.getElementById('invoice');
            const file = fileInput.files[0];

            if (!amount || amount <= 0) {
                alert('Enter a valid amount');
                return;
            }

            if (group.length === 0) {
                alert('Select at least one person');
                return;
            }

            let invoiceId = undefined;
            if (file) {
                invoiceId = await uploadFile(file);
                pendingInvoiceId = null;
            } else if (pendingInvoiceId) {
                invoiceId = pendingInvoiceId;
                pendingInvoiceId = null;
            }

            await client.mutation("expenses:add", { amount, paidBy: person, note: note || "", group, invoiceId });
            document.getElementById('amount').value = '';
            document.getElementById('note').value = '';
            document.getElementById('invoiceStatus').textContent = '';
            fileInput.value = '';
            document.querySelectorAll('.groupCheck').forEach(cb => cb.checked = true);
        }

        async function removeExpense(id) {
            await client.mutation("expenses:remove", { id });
        }

        async function editExpense(id) {
            const expense = expenses.find(e => e._id === id);
            if (!expense) return;

            document.getElementById('amount').value = expense.amount;
            document.getElementById('person').value = expense.paidBy;
            document.getElementById('note').value = expense.note || '';

            document.querySelectorAll('.groupCheck').forEach(cb => {
                cb.checked = (expense.group || people).includes(cb.value);
            });

            if (expense.invoiceId) {
                pendingInvoiceId = expense.invoiceId;
                document.getElementById('invoiceStatus').textContent = '[existing invoice will be kept]';
            }

            await client.mutation("expenses:remove", { id });
        }

        async function saveContact() {
            const person = document.getElementById('contactPerson').value;
            const platform = document.getElementById('platform').value.trim();
            const username = document.getElementById('username').value.trim();

            if (!platform || !username) {
                alert('Enter platform and username');
                return;
            }

            await client.mutation("contacts:add", { person, platform, username });
            document.getElementById('platform').value = '';
            document.getElementById('username').value = '';
        }

        function renderExpenses() {
            const list = document.getElementById('expenseList');
            list.innerHTML = expenses.map(e => {
                const noteStr = e.note ? ` - ${e.note}` : '';
                const group = e.group || people;
                const groupStr = group.length === people.length ? ' (Team)' : ` (${group.join(', ')})`;
                const invoiceUrl = e.invoiceId ? invoiceUrls[e.invoiceId] : null;
                const invoiceStr = invoiceUrl ? ` <a href="${invoiceUrl}" target="_blank">[invoice]</a>` : '';
                return `<li>${e.paidBy} paid $${e.amount.toFixed(2)}${noteStr}${groupStr}${invoiceStr} <button onclick="editExpense('${e._id}')">edit</button> <button onclick="removeExpense('${e._id}')">x</button></li>`;
            }).join('');
        }

        function renderContacts() {
            const list = document.getElementById('contactList');
            let html = '';
            people.forEach(p => {
                if (contacts[p] && contacts[p].length > 0) {
                    html += `<div class="contact-info"><b>${p}:</b> `;
                    html += contacts[p].map(c => `${c.platform}: ${c.username}`).join(', ');
                    html += '</div>';
                }
            });
            list.innerHTML = html;
        }

        function renderAuditLog() {
            const log = document.getElementById('auditLog');
            log.innerHTML = auditLog.map(e =>
                `[${e.timestamp}] ${e.action}: ${e.details}`
            ).join('<br>');
            log.scrollTop = log.scrollHeight;
        }

        function calculateBalances() {
            const balances = {};
            people.forEach(p1 => {
                balances[p1] = {};
                people.forEach(p2 => balances[p1][p2] = 0);
            });

            expenses.forEach(exp => {
                const group = exp.group || people;
                const share = exp.amount / group.length;
                group.forEach(p => {
                    if (p !== exp.paidBy) {
                        balances[p][exp.paidBy] += share;
                    }
                });
            });

            const net = {};
            people.forEach(p1 => {
                net[p1] = {};
                people.forEach(p2 => {
                    if (p1 < p2) {
                        const diff = balances[p1][p2] - balances[p2][p1];
                        net[p1][p2] = diff;
                    }
                });
            });

            return net;
        }

        function showCard(person) {
            const net = calculateBalances();
            const card = document.getElementById('card');
            const title = document.getElementById('cardTitle');
            const content = document.getElementById('cardContent');

            title.textContent = person + ' owes:';
            let html = '';

            if (contacts[person] && contacts[person].length > 0) {
                html += '<div><b>Contact:</b> ';
                html += contacts[person].map(c => `${c.platform}: ${c.username}`).join(', ');
                html += '</div><br>';
            }

            people.forEach(other => {
                if (other === person) return;

                let owes = 0;
                if (person < other) {
                    owes = net[person][other];
                } else {
                    owes = -net[other][person];
                }

                let contactStr = '';
                if (contacts[other] && contacts[other].length > 0) {
                    contactStr = ' (' + contacts[other].map(c => `${c.platform}: ${c.username}`).join(', ') + ')';
                }

                if (Math.abs(owes) < 0.01) {
                    html += `<div>${other}: settled${contactStr}</div>`;
                } else if (owes > 0) {
                    html += `<div class="negative">${other}: pay $${owes.toFixed(2)}${contactStr}</div>`;
                } else {
                    html += `<div class="positive">${other}: receive $${(-owes).toFixed(2)}${contactStr}</div>`;
                }
            });

            content.innerHTML = html;
            card.classList.add('active');
        }

        function exportExcel() {
            const net = calculateBalances();
            let csv = 'Expense Tracker Summary\n\n';

            csv += 'All Expenses\n';
            csv += 'Paid By,Amount,Note,Group\n';
            expenses.forEach(e => {
                const note = e.note ? `"${e.note}"` : '';
                const group = e.group || people;
                const groupStr = group.length === people.length ? 'Team' : group.join('; ');
                csv += `${e.paidBy},${e.amount.toFixed(2)},${note},${groupStr}\n`;
            });

            csv += '\nWho Owes Whom (positive = row owes column)\n';
            csv += ',' + people.join(',') + '\n';

            people.forEach(p1 => {
                let row = p1;
                people.forEach(p2 => {
                    if (p1 === p2) {
                        row += ',-';
                    } else {
                        let owes = 0;
                        if (p1 < p2) {
                            owes = net[p1][p2];
                        } else {
                            owes = -net[p2][p1];
                        }
                        row += ',' + owes.toFixed(2);
                    }
                });
                csv += row + '\n';
            });

            csv += '\nContact Information\n';
            csv += 'Person,Platform,Username\n';
            people.forEach(p => {
                if (contacts[p]) {
                    contacts[p].forEach(c => {
                        csv += `${p},${c.platform},${c.username}\n`;
                    });
                }
            });

            csv += '\nAudit Log\n';
            csv += 'Timestamp,Action,Details\n';
            auditLog.forEach(e => {
                csv += `${e.timestamp},${e.action},"${e.details}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'expenses.csv';
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
